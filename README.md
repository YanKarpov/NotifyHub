# NotifyHub — сервис отправки сообщений

## Архитектура и компоненты

### Backend (Rust + Actix-web + SQLx + Tokio):

- **HTTP API:**
  - `POST /enqueue` — добавить сообщение в очередь на отправку.
  - `GET /messages` — получить список последних сообщений с их статусами.
  - `GET /events` — SSE поток событий об изменениях статусов сообщений.
  - `GET /health` — проверка состояния сервиса.

- **База данных PostgreSQL** (работает в Docker):
  - Таблица `messages` хранит сообщения, их статусы, счетчик попыток и время следующей попытки (для отложенных сообщений).

- **Воркер (`worker_loop`):**
  - Периодически (каждые ~2-5 секунд) выбирает одно сообщение со статусом `pending` или `retrying`, у которого истекло время ожидания (`next_retry_at`).
  - Использует `FOR UPDATE SKIP LOCKED`, чтобы блокировать строку и не допускать конкурирующую обработку другими воркерами.
  - Отправляет сообщение через провайдер (`MockProvider`).
  - При успешной отправке обновляет статус в БД на `done`.
  - При ошибке увеличивает `retry_count`, обновляет статус на `retrying` и устанавливает `next_retry_at` с экспоненциальной задержкой (2^`retry_count` секунд).
  - Если число попыток превышает максимум (например, 5), меняет статус на `failed`.
  - Воркеры работают параллельно, не воруют задачи друг у друга благодаря `SKIP LOCKED`.


- **Event-driven оповещение:**
  - Воркеры отправляют сообщения в `broadcast::Sender`.
  - Клиенты подписываются на SSE-события и получают уведомления о статусах сообщений в реальном времени.


## Сборка и запуск

### Клонируем проект
```bash
git clone https://github.com/YanKarpov/NotifyHub.git
cd NotifyHub
```
### Собираем и запускаем
```
docker-compose up --build
```

